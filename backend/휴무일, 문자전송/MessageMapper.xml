<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.xml.MessageMapper">

  <resultMap id="MessageResultMap" type="com.gym.domain.message.MessageResponse">
    <id property="messageId" column="message_id"/>
    <result property="memberId" column="member_id"/>
    <result property="memberName" column="member_name"/>
    <result property="resvId" column="resv_id"/>
    <result property="closedId" column="closed_id"/>
    <result property="messageType" column="message_type"/>
    <result property="messageContent" column="message_content"/>
    <result property="messageDate" column="message_date"/>
  </resultMap>

  <!-- 문자 발송 내역 저장 -->
  <insert id="insertMessage" parameterType="com.gym.domain.message.Message" keyProperty="messageId">
    INSERT INTO message_tbl 
      (message_id, member_id, resv_id, closed_id, message_type, message_content, message_date)
    VALUES 
      (
        seq_message_id.NEXTVAL, 
        #{memberId, jdbcType=VARCHAR}, 
        #{resvId, jdbcType=NUMERIC}, 
        #{closedId, jdbcType=NUMERIC}, 
        #{messageType, jdbcType=VARCHAR}, 
        #{messageContent, jdbcType=CLOB}, 
        #{messageDate, jdbcType=TIMESTAMP}
      )
  </insert>

  <!-- 문자 단건 조회 -->
  <select id="selectMessageById" resultMap="MessageResultMap" parameterType="long">
    SELECT m.message_id, m.member_id, mem.member_name, m.resv_id, m.closed_id,
           m.message_type, m.message_content, m.message_date
    FROM message_tbl m
    LEFT JOIN member_tbl mem ON m.member_id = mem.member_id
    WHERE m.message_id = #{messageId}
  </select>

  <!-- 회원별 문자 목록 조회 -->
  <select id="selectMessagesByMember" resultMap="MessageResultMap" parameterType="map">
    SELECT m.message_id, m.member_id, mem.member_name, m.resv_id, m.closed_id,
           m.message_type, m.message_content, m.message_date
    FROM message_tbl m
    LEFT JOIN member_tbl mem ON m.member_id = mem.member_id
    WHERE m.member_id = #{memberId}
    ORDER BY m.message_date DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

  <!-- 예약별 문자 목록 조회 -->
  <select id="selectMessagesByReservation" resultMap="MessageResultMap" parameterType="long">
    SELECT m.message_id, m.member_id, mem.member_name, m.resv_id, m.closed_id,
           m.message_type, m.message_content, m.message_date
    FROM message_tbl m
    LEFT JOIN member_tbl mem ON m.member_id = mem.member_id
    WHERE m.resv_id = #{resvId}
    ORDER BY m.message_date DESC
  </select>

  <!-- 전체 문자 목록 조회 -->
  <select id="selectAllMessages" resultMap="MessageResultMap" parameterType="map">
    SELECT m.message_id, m.member_id, mem.member_name, m.resv_id, m.closed_id,
           m.message_type, m.message_content, m.message_date
    FROM message_tbl m
    LEFT JOIN member_tbl mem ON m.member_id = mem.member_id
    ORDER BY m.message_date DESC
    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  </select>

  <!-- 회원별 문자 개수 조회 -->
  <select id="countMessagesByMember" resultType="long" parameterType="string">
    SELECT COUNT(*) FROM message_tbl WHERE member_id = #{memberId}
  </select>

  <!-- 전체 문자 개수 조회 -->
  <select id="countAllMessages" resultType="long">
    SELECT COUNT(*) FROM message_tbl
  </select>

</mapper>
