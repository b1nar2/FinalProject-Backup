<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.annotation.PostMapper">

  <!-- 결과 매핑: PostResponse DTO에 DB 컬럼을 매핑 -->
  <resultMap id="PostResultMap" type="com.gym.domain.post.PostResponse">
    <id property="postId" column="post_id"/>
    <result property="boardId" column="board_id"/>
    <result property="postTitle" column="post_title"/>
    <result property="postContent" column="post_content"/>
    <result property="memberId" column="member_id"/>
    <result property="memberName" column="member_name"/> <!-- 조인 결과 컬럼 -->
    <result property="postRegDate" column="post_reg_date"/>
    <result property="postViewCount" column="post_view_count"/>
    <result property="postNotice" column="post_notice"/>
    <result property="postSecret" column="post_secret"/>
    <result property="postType" column="post_type"/>
  </resultMap>

<!-- 게시글 등록: 시퀀스 자동채번을 위해 selectKey 사용 -->
<insert id="insertPost" parameterType="com.gym.domain.post.Post" keyProperty="postId">
  <!-- insert 실행 전에 시퀀스 값을 먼저 조회하여 postId 필드에 세팅 -->
  <selectKey keyProperty="postId" resultType="long" order="BEFORE">
    SELECT seq_post_id.NEXTVAL FROM dual
  </selectKey>

  INSERT INTO post_tbl (
    post_id, board_id, post_title, post_content, member_id,
    post_reg_date,     <!-- 등록일: DB SYSDATE 자동 입력 -->
    post_mod_date,     <!-- 수정일: 등록 시점엔 NULL -->
    post_view_count,
    post_notice,
    post_secret,
    post_type
  ) VALUES (
    #{postId}, #{boardId}, #{postTitle}, #{postContent}, #{memberId},
    SYSDATE, NULL, 0,
    <choose>
      <when test="postNotice"> 'Y' </when>      <!-- Boolean true -> 'Y' -->
      <otherwise> 'N' </otherwise>              <!-- Boolean false -> 'N' -->
    </choose>,
    <choose>
      <when test="postSecret"> 'Y' </when>      <!-- Boolean true -> 'Y' -->
      <otherwise> 'N' </otherwise>              <!-- Boolean false -> 'N' -->
    </choose>,
    #{postType}
  )
</insert>


  <!-- 게시글 수정: 수정일은 DB SYSDATE, boolean 필드는 'Y'/'N'으로 저장 -->
  <update id="updatePost" parameterType="com.gym.domain.post.Post">
    UPDATE post_tbl SET
      post_title = #{postTitle},
      post_content = #{postContent},
      post_mod_date = SYSDATE,                      <!-- 수정시간 자동 입력 -->
      post_notice = 
        <choose>
          <when test="postNotice == true"> 'Y' </when>
          <otherwise> 'N' </otherwise>
        </choose>,
      post_secret = 
        <choose>
          <when test="postSecret == true"> 'Y' </when>
          <otherwise> 'N' </otherwise>
        </choose>,
      post_type = #{postType}
    WHERE post_id = #{postId}
  </update>

  <!-- 게시판별 게시글 목록 조회 (페이징, 검색, 공지 필터 포함) -->
  <select id="selectPostsByBoard" resultMap="PostResultMap" parameterType="map">
    SELECT
      p.post_id, p.board_id, p.post_title, p.post_content, p.member_id,
      m.member_name,
      p.post_reg_date, p.post_view_count, p.post_notice, p.post_secret, p.post_type
    FROM post_tbl p
    LEFT JOIN member_tbl m ON p.member_id = m.member_id
    WHERE p.board_id = #{boardId}
      <if test="keyword != null and keyword.trim() != ''">
        AND (p.post_title LIKE '%' || #{keyword} || '%' OR p.post_content LIKE '%' || #{keyword} || '%')
      </if>
      <if test="notice != null">
        AND p.post_notice = (CASE WHEN #{notice} THEN 'Y' ELSE 'N' END)
      </if>
    ORDER BY p.post_reg_date DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 게시글 단건 조회 -->
  <select id="selectPostById" resultMap="PostResultMap" parameterType="long">
    SELECT
      p.post_id, p.board_id, p.post_title, p.post_content, p.member_id,
      m.member_name,
      p.post_reg_date, p.post_view_count, p.post_notice, p.post_secret, p.post_type
    FROM post_tbl p
    LEFT JOIN member_tbl m ON p.member_id = m.member_id
    WHERE p.post_id = #{postId}
  </select>

  <!-- 게시글 삭제 -->
  <delete id="deletePostById" parameterType="long">
    DELETE FROM post_tbl WHERE post_id = #{postId}
  </delete>

  <!-- 게시판별 게시글 총 개수 조회 (검색 및 공지 필터 포함) -->
  <select id="countPostsByBoard" resultType="int" parameterType="map">
    SELECT COUNT(*)
    FROM post_tbl p
    WHERE p.board_id = #{boardId}
      <if test="keyword != null and keyword.trim() != ''">
        AND (p.post_title LIKE '%' || #{keyword} || '%' OR p.post_content LIKE '%' || #{keyword} || '%')
      </if>
      <if test="notice != null">
        AND p.post_notice = (CASE WHEN #{notice} THEN 'Y' ELSE 'N' END)
      </if>
  </select>

</mapper>
